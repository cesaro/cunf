
\documentclass[12pt,a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{mydefs}
%\usepackage{proof}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{figlatex}
\usepackage{enumerate}
\usepackage{url}
%\usepackage[a4paper]{geometry}
\usepackage[top=1cm,bottom=2cm,right=1cm,left=1cm]{geometry}
%\usepackage{a4wide}

\newtheorem{theorem}{Theorem}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{remark}[theorem]{Remark}

\newcommand{\hist}[1]{\ensuremath{\mathop{\mathsf{Hist}}{(#1)}}}
\newcommand{\conf}[1]{\ensuremath{\mathop{\mathsf{Conf}}{(#1)}}}
\newcommand{\confl}{\ensuremath\mathbin\#}
\newcommand{\evolves}{\ensuremath{\sqsubseteq}}
\newcommand{\devolves}{\evolves_{\!\!\!\uparrow}\;}

\newcommand{\peupdate}{\mbox{\sf pe\_update}}
\newcommand{\iscutoff}{\mbox{\sf is\_cutoff}}

\newcommand{\peupdatecont}{\mbox{\sf pe\_update\_context}}
\newcommand{\peupdatexisting}{\mbox{\sf pe\_update\_existing}}
\newcommand{\peupdatenew}{\mbox{\sf pe\_update\_new}}
\newcommand{\peupdategenhist}{\mbox{\sf pe\_update\_gen\_hist}}

%\setlength{\parskip}{0.3\baselineskip}
\begin{document}

%\title{Implementation of a complete prefix unfolder for contextual nets}

%\author{César Rodríguez\\[1ex](\textit{Under supervision of} Stefan Schwoon)\\[1em]LSV -- ENS Cachan}
%\date{August 2010}

%\maketitle
%\pagestyle{empty} %

Let $N = \langle P, T, F, C, m_0 \rangle$ be a 1-safe contextual net and $\unf
N = \langle P', T', F', C', m'_0 \rangle$ its full unfolding.

\paragraph{General assumptions}  No transition in $N$ has an empty preset,
i.e., $\pre t \ne \emptyset$ for all $t \in T$.

\begin{definition}
Let $c \in P'$ be a condition of $\unf N$.  A \emph{generating history} of $c$
is either a history $H \in \hist e$, where $\{e\} = \pre c$, or the empty set
$\emptyset$ if $c \in m'_0$.  A \emph{reading history} of $c$ is any history $H
\in \hist e$ for some $e \in \cont c$.  Finally, a \emph{history} of $c$ is any
set $H$ such that either
\begin{enumerate}
\item $H$ is a generating history of $c$, or
\item $H$ is a reading history of $c$, or
\item $H = H_1 \cup H_2$, where $H_1$ and $H_2$ are histories of $c$ verifying
$\lnot (H_1 \confl H_2)$.
\end{enumerate}
\end{definition}

\paragraph{Notation}  A pair $\langle e, H \rangle$ is called \emph{enriched
event} of $\unf N$ if $e \in T'$ and $H \in \hist e$.  Similarly, a pair
$\langle c, H \rangle$ is called \emph{enriched condition} of $\unf N$ if $H$
is a history of $c$.  We let variable $\varepsilon$ to range enriched events,
and variable $\rho$ to range enriched conditions.  Finally, we write
$\varepsilon \in \unf N$ (resp. $\rho \in \unf N$) to denote that $\varepsilon$
(resp. $\rho$) is an enriched event (resp. condition) of $\unf N$.  By
extension, an enriched condition $\rho = \langle c, H \rangle$ is called
\emph{generating} (resp. \emph{reading}) if $H$ is a generating (resp.
reading) history of $c$.

\begin{definition}
Given enriched conditions $\rho = \langle c, H \rangle$ and $\rho' = \langle
c', H' \rangle$ of $\unf N$, we say that $\rho$ is \emph{concurrent} to
$\rho'$, written $\rho \parallel \rho'$ iff $$\lnot (H \confl H') \land c, c'
\in \cut{H \cup H'}$$
\end{definition}

\begin{remark}
\label{rmk:the.statement}
Given enriched conditions $\rho = \langle c, H \rangle$ and $\rho' = \langle
c', H' \rangle$ of $\unf N$, the statement $\rho \parallel \rho'$ is equivalent
to the conjunction of the next four statements:
\begin{enumerate}
\item $\lnot (\exists e_1 \in H,\, \exists e_2 \in H' \setminus H,\, e_2
\nearrow e_1)$
\item $\lnot (\exists e_1 \in H',\, \exists e_2 \in H \setminus H',\, e_2
\nearrow e_1)$
\item $\lnot (\exists e \in H,\, c' \in \pre e)$
\item $\lnot (\exists e \in H',\, c \in \pre e)$
\end{enumerate}
\end{remark}

\begin{lemma}
\label{lem:let.c}
Let $C \in \conf{\unf N}$ be a configuration of $\unf N$. Let $e_1, e_2 \in C$
be events of $C$ and let $C_1 = C \sem{e_1}$, $C_2 = C \sem{e_2}$ be the
restriction of $C$ to $e_1$ and $e_2$.  Then $\lnot (C_1 \confl C_2)$.
\end{lemma}

\begin{proof}
By contradiction, let us assume that $C_1 \confl C_2$.  Then, one of the two
statements following must hold:

\begin{enumerate}
\item There exist $e \in C_1$ and $e' \in C_2 \setminus C_1$ verifying $e'
\nearrow e$.  As $e \in C_1$ and $C_1 = C\sem{e_1}$, we know that $e
\nearrow^*_C e_1$.  As $e' \nearrow e$ and $e' \in C$, we also know that $e'
\nearrow^*_C e_1$, which implies that $e' \in C_1$ holds.  But this is a
contradiction to the hypothesis $e' \in C_2 \setminus C_1$.

\item There exist $e \in C_2$ and $e' \in C_1 \setminus C_2$ verifying $e'
\nearrow e$.  The argument is analogous.
\end{enumerate}

In any case we reach a contradiction, so $C_1 \confl C_2$ does not hold.
\end{proof}

\begin{lemma}
\label{lem:c1c2c3}
Let $C_1, C_2, C_3 \in \conf{\unf N}$ be configurations of $\unf N$, such that
$\lnot (C_1 \confl C_2)$ and $\lnot (C_2 \confl C_3)$ and $\lnot (C_1 \confl
C_3)$.  Then, $\lnot (C_1 \confl (C_2 \cup C_3))$
\end{lemma}

\begin{proof}
(Sketch)  $C_2 \cup C_3$ is a configuration, since it is causally closed and
$\nearrow_C$ contains no loops (if it contains one loop, then we can see that
$C_2 \confl C_3$ holds).

By contradiction, assume that $C_1 \confl (C_2 \cup C_3)$ holds.  Then two
cases are possible:
\begin{enumerate}
\item There exist $e_1 \in C_1$ and $e_2 \in (C_2 \cup C_3) \setminus C_1$
verifying $e_2 \nearrow e_1$.  Then either $C_1 \confl C_2$ or $C_1 \confl
C_3$, a contradiction in any case.

\item There exist $e_1 \in C_2 \cup C_3$ and $e_2 \in C_1 \setminus (C_2 \cup
C_3)$ verifying $e_2 \nearrow e_1$.  Analogous argument.
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lem:let.c2}
Let $C \in \conf{\unf N}$ be a configuration $\unf N$.  Let $e_1, \ldots, e_n,
e'_1, \ldots, e'_m \in C$ be events of $C$ and let $C_i = C \sem{e_i}$, $C'_j =
C \sem{e_j}$, for $1 \le i \le n$ and $1 \le j \le m$ be the restriction of $C$
to, respectively, each $e_i$ and $e_j$.  Then $$\lnot \left ( \bigcup_{1
\le i \le n} C_i \ \confl \bigcup_{1 \le j \le m} C'_j \right )$$
\end{lemma}

\begin{proof}
By induction in the number $u = m + n$ of configurations:

\paragraph{Base} $u = m + n = 2$.  Recall that $n \ge 1$ and $m \ge 1$.  Then
we have that $m = n = 1$.  See \rlem{let.c}.

\paragraph{Step} $u = m + n \ge 3$. Assume that the statement is true for $2,
\ldots, u - 1$, where $u \ge 3$.  We have to prove it for $u$.  Provided that
$\confl$ is a symmetric relation, we assume without loss of generality that $m
\ge 2$.  Consider configurations $$B_1 \bydef = \bigcup_{1 \le i \le n} C_i
\qquad B_2 \bydef = C'_1 \qquad B_3 \bydef = \bigcup_{2 \le j \le m} C'_j$$ By
induction hypothesis, we know that $\lnot (B_1 \confl B_2)$, since $n + 1 < u$.
We also know that $\lnot (B_1 \confl B_3)$, since $n + m - 1 < u$, and that
$\lnot (B_2 \confl B_3)$, since $1 + m - 1 < u$.  Now by \rlem{c1c2c3} we have
that $$\lnot (B_1 \confl (B_2 \cup B_3)$$  This is exactly what we wanted to
prove.
\end{proof}

\begin{theorem}
\label{thm:any.event}
Let $e$ be an event of $\unf N$ such that $\{c_1, \ldots, c_k\} = \pre e$ and
$\{c_{k+1}, \ldots, c_n\} = \cont e$.  Then, there is a history $H \in \hist e$
iff there exist enriched conditions $\rho_1 = \langle c_1, H_1 \rangle, \ldots,
\rho_k = \langle c_k, H_k \rangle$ for conditions $c_1, \ldots, c_k$, and
generating enriched conditions $\rho_{k+1} = \langle c_{k+1}, H_{k+1} \rangle,
\ldots, \rho_n = \langle c_n, H_n \rangle$ for conditions $c_{k+1}, \ldots,
c_n$ such that $$\rho_i \parallel \rho_j \; \mbox{ for } 1 \le i < j \le n
\qquad \mbox{and} \qquad H = \{e\} \cup \bigcup_{1 \le i \le n} H_i$$
\end{theorem}

\begin{proof}
We proof both directions of the theorem.  From left to right, let $e$ be an
event of $\unf N$ and $H$ some history of $e$.  We see now how we can construct
the enriched conditions $\rho_1, \ldots, \rho_n$.  For $j \in \{k+1, \ldots,
n\}$, consider $c_j$.  If $c_j \in m'_0$, the initial marking of $\unf N$,
define $$H_j \bydef= \emptyset \qquad \mbox{ otherwise, define } \qquad H_j
\bydef= H \sem{e'}$$
%$$H_j \bydef= \begin{cases} \emptyset & \mbox{if } c_j \in m'_0 \\ H\sem{e'} &
%\mbox{otherwise} \end{cases}$$
where $\{e'\} = \pre{c_j}$.  Now, for $i \in \{1, \ldots, k\}$ consider $c_i$
and define $$H_i \bydef= \bigcup_{e' \in (\pre{c_i} \cup \cont{c_i}) \cap H} H
\sem{e'}$$ Notice that if $c_j$ is in the initial marking $m'_0$, then $H_j$ is
a generating history of $c_j$; otherwise $c_j$ must have some event $e'$ as
preset, case in which $H_j$ is a history $H\sem{e'} \in \hist{e'}$, and
therefore $H_j$ is again a generating history of $c_j$.  Remark that such $e'$
is in $H$, since $H$ is causally closed.  On the other hand, $H_i$ is the union
of a family of histories $H\sem{e'}$ such that $e'$ belongs to $H$ and to
$\pre{c_i} \cup \cont{c_i}$.  We claim that also in this case $H_i$ is a
history of $c_i$.  Indeed, if $e' \in \pre{c_i}$, then $H\sem{e'}$ is a
generating history of $c_i$; if $e' \in \cont{c_i}$, then $H\sem{e'}$ is a
reading history of $c_i$.  Furthermore, since all $e' \in (\pre{c_i} \cup
\cont{c_i}) \cap H$ are in $H$, by \rlem{let.c2}, we also know that every pair
of histories in the union is free of conflict.  Therefore, by the definition of
enriched condition, $H_i$ is a history of $c_i$.

Remark that in any case, $H_i$ (or $H_j$) is either $\emptyset$ or the union of
some histories $H\sem{e'}$ for certain $e'$ in $H$.  We claim now that, for $1
\le i < j \le n$ we have $\lnot (H_i \confl H_j)$.  If $H_i$ or $H_j$ is empty,
the statement is indeed true;  if $H_i \ne \emptyset$ and $H_j \ne \emptyset$,
then both $H_i$ and $H_j$ are the union of $H\sem{e'}$ for certain $e'$ in $H$,
so we can apply \rlem{let.c2} and conclude that $\lnot (H_i \confl H_j)$.

Now notice that the set $H_1 \cup \ldots \cup H_n$ is a configuration of $\unf
N$.  This roughly follows from the fact that every pair of histories is not in
conflict.  More formally, define $$C \bydef= H_1 \cup \ldots \cup H_n$$ Then
$C$ is causally closed, that is, $e' \in C$ and $e'' < e'$ imply $e'' \in C$,
since every $H_i$ verify this property.  Notice also that $\nearrow_C$ is
acyclic.  Indeed, if there is a cycle $e_1 \nearrow_C \ldots \nearrow_C e_m
\nearrow_C e_1$, then two consecutive events $e_l$, $e_{l+1}$ of the cycle must
verify $e_l \in H_u$, $e_{l+1} \in H_v \setminus H_u$, $e_l \nearrow e_{l+1}$
and $u \ne v$.  Intuitively, the cycle must span over more than one $H_i$.  But
this implies that $H_u \confl H_v$, which is a contradiction.

In order to see that $\rho_i \parallel \rho_j$ holds for all $1 \le i < j \le
n$, it is enough to show that $\{c_1, \ldots, c_n\} \subseteq \cut{C}$.  First,
we claim that there is no event in $C$ consuming any condition $c_1$, \ldots,
$c_n$.  By contradiction, assume that there is some $e' \in C$ such that $c_i
\in \pre{e'}$, where $1 \le i \le n$.  Then it is easy to conclude that
$\nearrow_H$ is not free of loops, a contradiction to the fact that $H$ is a
history.  Now we have to see that $c_i$ is indeed generated by $C$.  Roughly,
this follows from the fact that, by construction, either $c_i$ is in $m'_0$ or
the event $e'$ is in $H_i$, where $\{e'\} = \pre{c_i}$.

Finally, we have to show that $$H = \{e\} \cup C$$  The key here is to note
that $C$ is the union of $H\sem{e'}$ for certain $e' \in H$.  We can write this
as $C = \bigcup_{e'} H\sem{e'}$.  Then, it is trivial to see that $H \supseteq
\{e\} \cup C$ holds.  To show that $H \subseteq \{e\} \cup C$, let $e' \in H$
be any event in $H$ different form $e$.  We have to show that $e'$ is in $C$.
As $e' \in H$, then $e' \nearrow^+_H e$ holds, and there exists some integer $u
\ge 2$ and events $e_1, \ldots, e_u \in H$ such that $e' = e_1 \nearrow \ldots
\nearrow e_u = e$.  We claim now that $e_{u-1} \in C$ holds.  To see this,
consider the two possible cases:

\begin{itemize}
\item $\post{e_{u-1}} \cap \pre e \ne \emptyset$.  Then, there is some
$c_i$, where $i \in \{1, \ldots, k\}$, such that $\{e_{u-1}\} = \pre{c_i}$.  By
construction, $e_{u-1} \in H_i \subseteq C$, and therefore $e_{u-1} \in C$.

\item $\post{e_{u-1}} \cap \ \cont e \ne \emptyset$.  Then, there is some
$c_j$, where $j \in \{k+1, \ldots, n\}$, such that $\{e_{u-1}\} = \pre{c_j}$.
Again by construction, $e_{u-1} \in H_j \subseteq C$, and therefore $e_{u-1}
\in C$.
\end{itemize}

As $e_{u-1}$ is in $C$, and $C$ is the union of certain histories $H\sem{e''}$
for some $e'' \in H$, wen can conclude that there is some $e'' \in H$ such that
$e_{u-1} \in H\sem{e''}$.  Then, by definition of history, $e' \in H\sem{e''}$,
and hence $e' \in C$.

This completes the left-to-right direction.  To see the opposite direction, let
$e \in T'$ be an event of $\unf N$ such that $\{c_1, \ldots, c_k\} = \pre e$
and $\{c_{k+1}, \ldots, c_n\} = \cont e$.  Let $\rho_1 = \langle c_1, H_1
\rangle, \ldots, \rho_k = \langle c_k, H_k \rangle$ be enriched conditions for
conditions $c_1, \ldots, c_k$, and let $\rho_{k+1} = \langle c_{k+1}, H_{k+1}
\rangle, \ldots, \rho_n = \langle c_n, H_n \rangle$ be generating enriched
conditions for conditions $c_{k+1}, \ldots, c_n$ such that $$\rho_i \parallel
\rho_j \; \mbox{ for } 1 \le i < j \le n$$  Now consider the set $H$, defined
as $$H = \{e\} \cup \bigcup_{1 \le i \le n} H_i$$ We have to show that $H$ is a
history of $e$.  To see this, it suffices to see that $H$ is a configuration
and that $H\sem{e}$ equals $H$.

\begin{description}
\item[] \emph{$H$ is causally closed.}  We prove that $e' \in H$ and $e'' < e'$
imply $e'' \in H$.  Either $e' = e$ or $e' \ne e$.  Assume that $e' = e$.
Then, there is an integer $u \ge 2$ and events $e_1, \ldots, e_u$ such that
$e'' = e_1 < \ldots < e_u = e'$ and $e_{i-1} \in \pre{(\pre{e_i} \cup
\cont{e_i})}$ for $2 \le i \le n$.  Then, by construction, $e_{u-1} \in H_l$
for some $1 \le l \le n$.  As $H_l$ is causally closed, we have that $e'' \in
H_l$.  Finally, as $H_l \subseteq H$, we can conclude that $e'' \in H$.

If we now assume that $e' \ne e$, then $e' \in H_l$ for some $1 \le l \le n$.
Again, as $H_l$ is causally closed, $e'' \in H_l$ follows immediately and
therefore $e'' \in H$.

\item[] \emph{Relation $\nearrow_H$ is acyclic.}  By contradiction, assume that
$e_1 \nearrow e_2 \nearrow \ldots \nearrow e_u \nearrow e_1$, where $u \ge 2$
and $e_i \in H$ for $1 \le i \le u$, is a cycle.  If event $e$ does not
participate in the cycle, that is, $e_i \ne e$ for $1 \le i \le u$, it is easy
to see that there exist two consecutive events $e_l$ and $e_{l+1}$ such that
$e_l \in H_i$ and $e_{l+1} \in H_j \setminus H_i$, where $1 \le l \le u$ and $1
\le i, j \le n$ and $i \ne j$.  This implies that $H_i \confl H_j$, a
contradiction to $\rho_i \parallel \rho_j$.  So let us assume that $e$
participates in the cycle.  W.l.o.g., assume that $e = e_1$, and consider event
$e_2$.  As we have $e_1 \nearrow e_2$, three cases are possible:

\begin{itemize}
\item Assume that $e < e_2$.  Then, $e_2 \ne e$ and we can say that $e_2 \in
H_l$ for some $1 \le l \le n$.  Since $H_l$ is causally closed, then $e \in
H_l$, and $H_l$ consumes condition $c_1$, which leads to $\lnot (\rho_1
\parallel \rho_l)$.  This is a contradiction.

\item Assume that $\cont e \cap \pre{e_2} \ne \emptyset$.  Similarly, we know
that $e_2 \in H_l$ for some $1 \le l \le n$.  Then, $H_l$ consumes some $c_j$,
for $k < j \le n$ and we have $\lnot (\rho_j \parallel \rho_l)$, which is a
contradiction.

\item Assume that $\pre e \cap \pre{e_2} \ne \emptyset$.  The argument is
analogous.
\end{itemize}

\item[] \emph{$H\sem{e} = H$ holds.}  By definition, we have $H\sem{e}
\subseteq H$.  In order to see that $H\sem{e} \supseteq H$, let $e' \in H$ be
an event of $H$.  We have to show that $e' \nearrow^*_H e$.  If $e' = e$, we
are done, so assume that $e' \ne e$.  Then, by definition of $H$, we have that
$e' \in H_l$ for some $1 \le l \le n$.  Two cases are possible:

\begin{itemize}
\item Assume that $e' \in H_i$, where $i \in \{1, \ldots, k\}$.  Then $e'
\nearrow^*_{H_i} e''$ for some $e'' \in \pre{c_i} \cup \cont{c_i}$.  Notice
that such $e''$ verifies $e'' \nearrow e$, since either $e'' < e$ or
$\cont{e''} \cap \pre e \ne \emptyset$.  Then we can write $e' \nearrow^*_{H_i}
e'' \nearrow e$.  As $H_i \subseteq H$, we can simplify to $e' \nearrow^*_H e$.

\item Assume that $e' \in H_j$, where $j \in \{k+1, \ldots, n\}$.  Then $e'
\nearrow^*_{H_j} e''$, where $\{e''\} = \pre{c_j}$.  Such $e''$ verifies $e'' <
e$, as well as $e'' \nearrow e$.  Then we have that $e' \nearrow^*_{H_j} e''
\nearrow e$, and again $e' \nearrow^*_H e$.
\end{itemize}
\end{description}
\end{proof}

\begin{lemma}
\label{lem:be.configurations}
Let $C_1, C_2, C_3 \in \conf{\unf N}$ be configurations of the full unfolding
such that $C_1 \evolves C_2$ and $C_1 \confl C_3$.  Then, $C_2 \confl C_3$.
\end{lemma}
\begin{proof}
Since $C_1 \confl C_3$ holds, two cases are possible:

\begin{itemize}
\item There is some $e_1 \in C_3$ and some $e_2 \in C_1 \setminus C_3$ with
$e_2 \nearrow e_1$.  By hypothesis $C_1 \evolves C_2$ and consequently $C_1
\subseteq C_2$. This leads to $e_2 \in C_2 \setminus C_3$.  Hence $C_2 \confl
C_3$.

\item There is some $e_1 \in C_1$ and some $e_2 \in C_3 \setminus C_1$ with
$e_2 \nearrow e_1$.  Due to the fact that $C_1 \subseteq C_2$, we have that
$e_1 \in C_2$.  We claim now that $e_2 \not\in C_2$ holds.  By contradiction,
if $e_2 \in C_2$ holds, then $e_2 \in C_2 \setminus C_1$ holds.  This, together
with $e_1 \in C_1$ and $e_2 \nearrow e_1$ entails $C_1 \not\evolves C_2$, a
contradiction to our hypothesis.  So $e_2 \not\in C_2$ holds, and consequently
$e_2 \in C_3 \setminus C_2$ also holds.  Hence $C_2 \confl C_3$.
\end{itemize}
\end{proof}

\begin{lemma}
\label{lem:two.histories}
Let $H, H'$ be two histories of $\unf N$, with $H' \prec H$ for some adequate
order $\prec$, and such that $H \in \hist{e}$ and $e \in H'$.  Then $H \confl
H'$.
\end{lemma}

\begin{proof}
We claim that $H \not\sqsubseteq H'$.  Indeed, if it were the case that $H
\evolves H'$, we would have $H \prec H'$, a contradiction to the hypothesis $H'
\prec H$, provided that any adequate order $\prec$ is antisymmetric.  So $H
\not\sqsubseteq H'$ holds.  One can then write the next equivalence: $$H
\not\sqsubseteq H' \iff H \not\subseteq H' \lor \exists e_1 \in H,\, \exists
e_2 \in H' \setminus H,\, e_2 \nearrow e_1$$  As $H \not\sqsubseteq H'$ holds,
the right-hand side also holds.  We show that both sides of the disjunction in
the right-hand size implies $H \confl H'$.

Clearly, $\exists e_1 \in H,\, \exists e_2 \in H' \setminus H,\, e_2 \nearrow
e_1$ implies $H \confl H'$.  On the other hand, $H \not\subseteq H'$ implies
that we can find some event $e'' \in H \setminus H'$.  Now notice that, as $e''
\in H$, it holds that $e'' \nearrow^*_H e$.  Event $e$ and $e''$ must be
different because $e \in H'$ by hypothesis and $e'' \notin H'$.  Consequently
it also holds that $e'' \nearrow^+_H e$.  This means that we can find a finite
number $n \ge 2$ of events $e_1, \ldots, e_n \in H$ with $e'' = e_1 \nearrow
e_2 \nearrow \ldots \nearrow e_n = e$.  Then, it is easy to see that there is
some pair of events $e_l, e_{l+1}$ for some $l \in \{1, \ldots, n - 1\}$
verifying $e_l \in H \setminus H'$ and $e_{l+1} \in H'$.  By construction, $e_l
\nearrow e_{l+1}$.  Hence $H \confl H'$.
\end{proof}

\begin{theorem}
Let $\rho = \langle c, H \rangle$ be an enriched condition of $\unf N$ such
that $H$ is either a generating or reading history of $c$.  Let $e$ be an event
of $\unf N$ such that $H \in \hist{e}$ and such that $\{c_1, \ldots, c_k\} =
\pre e$ and $\{c_{k+1}, \ldots, c_n\} = \cont e$.  Let $\rho_1 = \langle c_1,
H_1 \rangle, \ldots, \rho_k = \langle c_k, H_k \rangle$ be enriched conditions
for conditions $c_1, \ldots, c_k$, and let $\rho_{k+1} = \langle c_{k+1},
H_{k+1} \rangle, \ldots, \rho_n = \langle c_n, H_n \rangle$ be generating
enriched conditions for conditions $c_{k+1}, \ldots, c_n$, such that $\rho_i
\parallel \rho_j$ for $1 \le i < j \le n$ and $H = \{e\} \cup \bigcup_{1 \le i
\le n} H_i$.  Finally, let $\rho' = \langle c', H' \rangle$ be an enriched
condition such that, for some adequate order $\prec$ and some $m \ge 1$, there
are enriched conditions $\rho'_1 = \langle c', H'_1 \rangle, \ldots, \rho'_m =
\langle c', H'_m \rangle$ verifying $H' = H'_1 \cup \ldots \cup H'_m$ and
$\rho'_i \parallel \rho'_j$ for $1 \le i < j \le m$ and $H'_i \prec H$ for $1
\le i \le m$.  Then, $$\rho \parallel \rho' \iff
\left ( \bigwedge_{1 \le i \le k} \rho_i \parallel \rho' \right ) \land 
\left ( \bigwedge_{k < j \le n} \rho_j \parallel \rho' \right ) \land 
\left ( c' \notin \pre e \right ) \land
\left ( \lnot \exists e'' \in H' \setminus H,\, \cont{e''} \cap \pre e \ne
\emptyset \right )$$
\end{theorem}

\begin{proof}
Note that the existence of such $\rho_1, \ldots, \rho_n$ is assured by
\rthm{any.event} and the assumption $H \in \hist{e}$.  History $H$ is assumed
to be either a generating or a reading history of $c$.  We prove both
directions of the co-implication by regarding separately this two cases.

First, assume that $H$ is a generating history of $c$.  From left to right, we
prove that the hypothesis implies each one of the conjunctions.


\begin{enumerate}[(a)]
\item $\rho \parallel \rho' \implies \bigwedge_{1 \le i \le k} \rho_i \parallel
\rho'$.  It is enough to see that $\rho \parallel \rho' \implies \rho_i
\parallel \rho'$ for \emph{some} $\rho_i$.  As we do not make any assumption on
$\rho_i$, the proof will be valid for \emph{all} $\rho_i$.

Assume that $\rho \parallel \rho'$ holds and that, for a proof by contradiction,
$\lnot (\rho_i \parallel \rho')$ holds for some $i \in \{1, \ldots, k\}$.  Then we
know that at least one of the four statements in \rrmk{the.statement} must be
false when regarding $\rho_i$ and $\rho'$.  We proceed by cases:

\begin{enumerate}[1.]
\item Assume that there exist $e_1 \in H'$ and $e_2 \in H_i \setminus H'$ with
$e_2 \nearrow e_1$.  Then, as $H_i \subseteq H$, we have that $e_2 \in H
\setminus H'$.  This together with $e_1 \in H'$ and $e_2 \nearrow e_1$ implies
$H \confl H'$, which is a contradiction to $\rho \parallel \rho'$.

\item Assume that there exist events $e_1 \in H_i$ and $e_2 \in H' \setminus
H_i$ with $e_2 \nearrow e_1$.  Two cases are possible: either $e_2 \in H$ or
$e_2 \notin H$.  If $e_2 \notin H$, as $H_i \subseteq H$, we have that $e_1 \in
H$, $e_2 \in H' \setminus H$ and $e_2 \nearrow e_1$, which implies $H \confl
H'$.  This is a contradiction to $\rho \parallel \rho'$.  So, let us assume
that $e_2 \in H$.  As $H = \{e\} \cup \bigcup_{1 \le i \le k} H_i \cup
\bigcup_{k < j \le n} H_j$, three cases are possible:

\begin{itemize}
\item $e_2 \in H_{i'}$ for some $i' \in \{1, \ldots, k\}$ with $i' \ne i$.
Again, we have $e_1 \in H_i$, $e_2 \in H_{i'} \setminus H_i$ and $e_2 \nearrow
e_1$.  This implies $H_i \confl H_{i'}$, a contradiction to $\rho_i \parallel
\rho_{i'}$.

\item $e_2 \in H_j$ for some $j \in \{k+1, \ldots, n\}$.  Likewise, we have
$e_1 \in H_i$, $e_2 \in H_j \setminus H_i$, $e_2 \nearrow e_1$, and
consequently $H_i \confl H_j$.  This is a contradiction to $\rho_i \parallel
\rho_j$.

\item $e_2 = e$.  By the definition of history, we have $e_1 \nearrow^*_H
e$, since $e_1 \in H_i \subseteq H$.  As $e_2 = e$, we have $e \nearrow e_1$.
This leads to the cycle $e_1 \nearrow^*_H e \nearrow e_1$ in the asymmetric
conflict relation restricted to $H$, which is a contradiction to the fact that
$H$ is a history.
\end{itemize}

\item Assume that there exists $e_1 \in H_i$ such that $c' \in \pre{e_1}$.
Intuitively, this means that $H_i$ consumes $c'$.  As $H_i \subseteq H$, also
$H$ consumes $c'$, which leads to a contradiction to $\rho \parallel \rho'$.

\item Assume that there exists $e_1 \in H'$ such that $c_i \in \pre{e_1}$.  We
have two cases, either $e_1 = e$ or $e_1 \ne e$.  If we assume that $e_1 \ne
e$, then we have that $\pre e \cap \pre{e_1} \ne \emptyset$.  This implies that
$e \nearrow e_1$ and that $e_1 \nearrow e$.  In turn, it implies that $e_1
\notin H$ (otherwise we would have a loop in the relation $\nearrow$ restricted
to $H$).  So assuming that $e_1 \ne e$ would lead to conclude that $e_1 \in H'
\setminus H$ and that $e_1 \nearrow e$, with $e \in H$, which implies that $H
\confl H'$, a contradiction to $\rho \parallel \rho'$.

Therefore, let us assume that $e_1 = e$ and consequently that $e \in H'$.
Since $H' = \cup_{1 \le i \le m} H'_i$, we have that $e \in H'_i$ for some
$H'_i$.  Asume, without loss of generality, that $i = 1$ and that $e \in H'_1$.
By hypothesis we know that $H'_1 \prec H$, so we can apply \rlem{two.histories}
and conclude that $H'_1 \confl H$.  Now, as every pair of histories $H'_i,
H'_j$ is free of conflict, we can easily conclude that $H'_1 \evolves H'$.
Now, we use this fact to apply \rlem{be.configurations} and conclude that $H'
\confl H$.  This is a contradiction to $\rho \parallel \rho'$.
\end{enumerate}

\item $\rho \parallel \rho' \implies \bigwedge_{k < j \le n} \rho_j \parallel
\rho'$.  As in (a), it is still enough to prove that the statement holds for
just one $\rho_j$.  In particular, we will prove that $\rho \parallel \rho'
\implies \rho_j \parallel \rho'$ for some $j \in \{k+1, \ldots, n\}$.  As we
make no assumption about $\rho_j$, the argument will be valid for \emph{all}
$\rho_j$.

We reason by contradiction.  Assume that both $\rho \parallel \rho'$ and $\lnot
(\rho_j \parallel \rho')$ hold.  As $\lnot (\sigma_j \parallel \rho')$, we know
that at least one of the four statements in \rrmk{the.statement} must not hold.
In the following, we see that we can find a contradiction in each case.

\begin{enumerate}[1.]
\item Assume that there exist $e_1 \in H'$ and $e_2 \in H_j \setminus H'$ with
$e_2 \nearrow e_1$.  The same argument as in (a.1) is applicable here, changing
$H_i$ by $H_j$.

\item Assume that there exist events $e_1 \in H_j$ and $e_2 \in H' \setminus
H_j$ with $e_2 \nearrow e_1$.  As in (a.2), two cases are possible: either $e_2
\in H$ or $e_2 \notin H$.  If $e_2 \notin H$, we have $e_2 \in H' \setminus H$.
Since $H_j \subseteq H$, we have that $e_1 \in H$.  This implies $H \confl H'$,
a contradiction to $\rho \parallel \rho'$.  So, let us assume that $e_2 \in H$.
As $H = \{e\} \cup \bigcup_{1 \le i \le k} H_i \cup \bigcup_{k < j \le n} H_j$,
three cases are possible:

\begin{itemize}
\item $e_2 \in H_{j'}$ for some $j' \in \{k+1, \ldots, n\}$ with $j' \ne j$.
Again, we have $e_1 \in H_j$, $e_2 \in H_{j'} \setminus H_j$ and $e_2 \nearrow
e_1$.  This implies $H_j \confl H_{j'}$, a contradiction to $\rho_j \parallel
\rho_{j'}$.

\item $e_2 \in H_i$ for some $i \in \{1, \ldots, k\}$.  Likewise, we have $e_1
\in H_j$, $e_2 \in H_i \setminus H_j$, $e_2 \nearrow e_1$, and consequently
$H_j \confl H_i$, which is a contradiction to $\rho_j \parallel \rho_i$.

\item $e_2 = e$.  By the definition of history and the fact that $e_1 \in H_j
\subseteq H$, we have $e_1 \nearrow^*_H e$.  By hypothesis, we have $e_2 = e$
and $e_2 \nearrow e_1$.  This leads to the cycle $e_1 \nearrow^*_H e \nearrow
e_1$ in the asymmetric conflict relation restricted to $H$, which is a
contradiction to the fact that $H$ is a history.
\end{itemize}

\item Assume that there exists $e_1 \in H_j$ such that $c' \in \pre{e_1}$.
Same argument as in (a.3), substituting $H_i$ by $H_j$.

\item Assume that there exists $e_1 \in H'$ such that $c_j \in \pre{e_1}$. We
can assume that $e \notin H'$, since if it were the case that $e \in H'$, by
\rlem{be.configurations} and \rlem{two.histories}, we would have $H \confl H'$,
a contradiction.  This implies that $e_1 \ne e$.  Furthermore, we also know
that $e \nearrow e_1$, since $\cont{e} \cap \pre{e_1} \ne \emptyset$.  Then, we
have $H \confl H'$, a contradiction to $\rho \parallel \rho'$.
\end{enumerate}

\item $\rho \parallel \rho' \implies c' \notin \pre e$.  If $c' \in \pre e$,
then there is an event $e \in H$ that consumes $c'$, which is (by the third
statement of \rrmk{the.statement}) a contradiction to $\rho \parallel \rho'$.

\item $\rho \parallel \rho' \implies \lnot \exists e'' \in H' \setminus
H,\, \cont{e''} \cap \pre e \ne \emptyset$  Assume, for an argument by
contradiction, that there exists some $e'' \in H' \setminus H$
such that $\cont{e''} \cap \pre e \ne \emptyset$.  In consequence, we have
$e'' \nearrow e$, with $e \in H$ and $e'' \in H' \setminus H$, which implies $H
\confl H'$, a contradiction to $\rho \parallel \rho'$.
\end{enumerate}

We prove now the opposite direction of the theorem, still assuming that $H$ is
a generating history of $c$.  We prove that $\rho \parallel \rho'$ holds if we
assume the right-hand side.

\item $\rho \parallel \rho' \Longleftarrow
\left ( \bigwedge_{1 \le i \le k} \rho_i \parallel \rho' \right ) \land 
\left ( \bigwedge_{k < j \le n} \rho_j \parallel \rho' \right ) \land 
\left ( c' \notin \pre e \right ) \land
\left ( \lnot \exists e'' \in H' \setminus H,\, \cont{e''} \cap \pre e \ne
\emptyset \right )$ By contradiction, we assume that the right-hand side of the
implication and the negation of the left-hand side hold.  As $\lnot (\rho
\parallel \rho')$, one of the four statements of \rrmk{the.statement} must be
false:

\begin{enumerate}[$i$.]
\item Assume that there exist events $e_1 \in H$ and $e_2 \in H' \setminus H$
with $e_2 \nearrow e_1$.  Recall that $H = \{e\} \cup \bigcup_{1 \le i \le k}
H_i \cup \bigcup_{k < j \le n} H_j$.  We regard $e_1$ and reason by cases:

\begin{itemize}
\item Assume that $e_1 \in H_i$ for some $i \in \{1, \ldots, k\}$. As $H_i
\subseteq H$, we still have $e_2 \in H' \setminus H_i$, and hence $H_i \confl
H'$, a contradiction to $\rho_i \parallel \rho'$.

\item Assume that $e_1 \in H_j$ for some $j \in \{k+1, \ldots, n\}$.  In
the same way, we can see that $H_j \confl H'$ holds, a contradiction.

\item Finally, assume that $e_1 = e$ and, consequently, $e_2 \nearrow e$.
Three cases are possible:

\begin{itemize}
\item Assume that $e_2 < e$.  We know that $H$ is a history, and by definition
contains all events $e'' < e$.  As $e_2$ is one such event, we have $e_2 \in
H$, which is a contradiction to the assumption $e_2 \in H' \setminus H$.

\item Assume that $\cont{e_2} \cap \pre e \ne \emptyset$.  This is a
contradiction to the last conjunction in the hypothesis of the statement that
we are proving.

\item Assume that $\pre{e_2} \cap \pre e \ne \emptyset$.  Under this
assumption, $e_2 \in H'$ clearly consumes $c_i$ for some $i \in \{1, \ldots,
k\}$.  This implies that $\lnot (\rho' \parallel \rho_i)$, a contradiction.
\end{itemize}
\end{itemize}

\item Assume that there exist events $e_1 \in H'$ and $e_2 \in H \setminus H'$
with $e_2 \nearrow e_1$.  Using the same arguments present in ($i$), we can
immediately discard the cases where $e_2 \in H_i$ for some $i \in \{1, \ldots,
k\}$ or $e_2 \in H_j$ for some $j \in \{k+1, \ldots, n\}$.  We assume, hence,
that $e_2 = e$.  Three cases are possible:

\begin{itemize}
\item Assume that $e < e_1$.  As $H'$ is causally closed and $e_1 \in H'$, we
conclude that $e \in H'$.  But $e$ consumes every $c_i$ with $i \in \{1,
\ldots, k\}$ when fired, which implies $\lnot (\rho_i \parallel \rho')$ for any
such $i$.  This a contradiction.

\item Assume that $\cont e \cap \pre{e_1} \ne \emptyset$.  Then $c_j \in
\pre{e_1}$ for any $j \in \{k+1, \ldots, n\}$.  As $e_1 \in H'$, we have that
$\lnot (\rho_j \parallel \rho')$.  This is a contradiction.

\item Assume that $\pre e \cap \pre{e_1} \ne \emptyset$.  Then event $e_1 \in
H'$ consumes $c_i$ for any $i \in \{1, \ldots, k\}$, which leads to the
contradiction $\lnot (\rho_i \parallel \rho)$.
\end{itemize}

\item Assume that there exists $e_1 \in H$ such that $c' \in \pre{e_1}$.  If we
assume $e_1 \in H_i$ for some $i \in \{1, \ldots, k\}$, we will find the
contradiction $\lnot (\rho_i \parallel \rho')$.  Similarly, if we assume $e_1
\in H_j$ for some $j \in \{k+1, \ldots, n\}$ we will reach the
contradiction $\lnot (\rho_j \parallel \rho')$.  So the only case that we
can consider is when $e_1 = e$.  If $c' \in \pre e$, we have that $c' = c_i$
for some $i \in \{1, \ldots, k\}$.  This is a contradiction to our hypothesis.

\item Assume that there exists $e_1 \in H'$ such that $c \in \pre{e_1}$.  Then
$e \in H'$, and $H'$ consumes any $c_i$ for $i \in \{1, \ldots, k\}$, which is
a contradiction to $\rho_i \parallel \rho'$.
\end{enumerate}

So far, we assumed that $H$ was a generating history of $c$.  Let us assume now
that $H$ is a reading history.  To prove the co-implication, we can prove again
both direction separately.  From left to right, exactly the same argument still
works, due basically to the fact that, in our proof, we do not rely on any
particular relation between $e$ and $c$.  From right to left, \emph{almost} the
same argument works, as we see in the sequel.

\item $\rho \parallel \rho' \Longleftarrow
\left ( \bigwedge_{1 \le i \le k} \rho_i \parallel \rho' \right ) \land 
\left ( \bigwedge_{k < j \le n} \rho_j \parallel \rho' \right ) \land 
\left ( c' \notin \pre e \right ) \land
\left ( \lnot \exists e'' \in H' \setminus H,\, \cont{e''} \cap \pre e \ne
\emptyset \right )$ By contradiction, we assume the right-hand side of the
implication and the negation of the left-hand side.  As $\lnot (\rho \parallel
\rho')$, one of the next four statements must hold:

\begin{enumerate}[1.]
\item There exist events $e_1 \in H$ and $e_2 \in H' \setminus H$ verifying
$e_2 \nearrow e_1$.  Same argument than in ($i$).

\item There exist events $e_1 \in H'$ and $e_2 \in H \setminus H'$ verifying
$e_2 \nearrow e_1$.  Same argument than in ($ii$).

\item There exists $e_1 \in H$ such that $c' \in \pre{e_1}$.  Same argument
than in ($iii$).

\item There exists $e_1 \in H'$ such that $c \in \pre{e_1}$.  Since $c = c_j$
for some $j \in \{k+1, \ldots, n\}$, we have that $c_j \in \pre{e_1}$.  This
implies that $\lnot (\rho_j \parallel \rho')$ for such $j$, which is a
contradiction.
\end{enumerate}
\end{proof}


\begin{theorem}
Let $\rho_1 = \langle c, H_1 \rangle$, $\rho_2 = \langle c, H_2 \rangle$, $\rho
= \langle c, H \rangle$ and $\rho' = \langle c', H' \rangle$ be enriched
conditions such that $H = H_1 \cup H_2$ and $\lnot (H_1 \confl H_2)$.  Then,
$$\rho \parallel \rho' \iff \rho_1 \parallel \rho' \land \rho_2 \parallel
\rho'$$
\end{theorem}

\begin{proof}
From left to right, and for an argument by contradiction, let us assume that
$\rho \parallel \rho'$ and $\lnot (\rho_1 \parallel \rho')$ hold.  Then one of
the our statements in \rrmk{the.statement} must be false:

\begin{enumerate}
\item There exist $e_1 \in H'$ and $e_2 \in H_1 \setminus H'$ verifying $e_2
\nearrow e_1$.  As $e_2 \in H \setminus H'$, it also holds that $H \confl H'$,
a contradiction to $\rho \parallel \rho'$.

\item There exist $e_1 \in H_1$ and $e_2 \in H' \setminus H_1$ verifying $e_2
\nearrow e_1$.  As $H_1 \subseteq H$, we have $e_1 \in H$.  Regarding $e_2$, we
have two cases: either $e_2 \notin H$ or $e_2 \in H$.  Assuming the former,
immediately lead us to the contradiction $H \confl H'$.  Assuming, however,
that $e_2 \in H = H_1 \cup H_2$ leads to the fact that $e_2 \in H_2 \setminus
H_1$.  In turn, this implies $H_1 \confl H_2$, a contradiction to our
hypothesis.

\item There exists $e \in H_1$ such that $c' \in \pre e$.  Then $e \in H$ and
$H$ also consumes $c'$ when fired, a contradiction to $\rho \parallel \rho'$.

\item There exists $e \in H'$ such that $c \in \pre e$.  This is a
contradiction to $\rho \parallel \rho'$.
\end{enumerate}

From right to left, let's assume that the statements $\rho_1 \parallel \rho'$,
$\rho_2 \parallel \rho'$ and $\lnot (\rho \parallel \rho')$ hold.  As $\lnot
(\rho \parallel \rho')$, by \rrmk{the.statement}, we must consider four cases:

\begin{enumerate}
\item There exist $e_1 \in H$ and $e_2 \in H' \setminus H$ verifying $e_2
\nearrow e_1$.  Then eiter $e_1 \in H_1$, and $H_1 \confl H'$ holds, or $e_1
\in H_2$ and $H_2 \confl H'$ holds. In any case we reach a contradiction to
hour hypothesis.

\item There exist $e_1 \in H'$ and $e_2 \in H \setminus H'$ verifying $e_2
\nearrow e_1$.  Same argument than before, regarding $e_2$ instead of $e_1$.

\item There exists $e \in H$ such that $c' \in \pre e$.  Either $e \in H_1$ and
$\lnot (\rho_1 \parallel \rho')$ or $e \in H_2$ and $\lnot (\rho_2 \parallel
\rho')$.  In any case we reach a contradiction to our hypothesis.

\item There exists $e \in H'$ such that $c \in \pre e$.  This is a
contradiction to $\rho_1 \parallel \rho'$.
\end{enumerate}
\end{proof}

\end{document}

 % vim:syn=tex:spell:
